<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8">
  <title>我要大紫光</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: "Microsoft YaHei", Arial, sans-serif;
      margin: 20px;
      background: #f9f9f9;
      color: #333;
    }

    h2 {
      text-align: center;
      color: #6a0dad;
      font-size: 28px;
      margin-bottom: 20px;
    }

    .controls {
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      width: 400px;
      margin: 0 auto 20px auto;
    }

    .controls div {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    .controls label {
      width: 150px;
      text-align: right;
      font-weight: bold;
      color: #444;
      margin-right: 10px;
    }

    .controls input {
      flex: 1;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    #results {
      text-align: center;
      font-size: 16px;
      margin-bottom: 20px;
      color: #333;
    }

    canvas {
      display: block;
      margin: 0 auto;
      background: #fff;
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>

<body>
  <h2>我要大紫光</h2>

  <div class="controls">
    <div>
      <label>初始概率 (α):</label>
      <input type="text" id="alpha" value="0.005">
    </div>
    <div>
      <label>最多投入数量 (N):</label>
      <input type="text" id="N" value="50">
    </div>
    <div>
      <label>初始气息 (B):</label>
      <input type="text" id="B" value="0">
    </div>
    <div>
      <label>已经失败次数 (I):</label>
      <input type="text" id="I" value="0">
    </div>
    <div>
      <label>计算点 X:</label>
      <input type="text" id="Xinput" value="10">
    </div>
  </div>

  <p style="text-align:center;"><strong>固定参数:</strong> K=10, η=46.466, M=100</p>
  <p id="results"></p>

  <canvas id="chart" width="800" height="400"></canvas>

  <script>
    const K = 10, eta = 46.466, M = 100;

    function computeYandG(alpha, N, X, B, I) {
      let cumulative = B;
      let G = null;
      let probFail = 1.0;
      let Y = 0.0;
      const maxIter = 1000;

      for (let i = 1; i <= maxIter; i++) {
        if (cumulative >= M && G === null) {
          G = i; // 达到 M 的位置
        }

        let failCount = I + (i - 1);
        let a_i;
        if (cumulative >= M) {
          a_i = 1.0;
        } else {
          if (failCount <= K) {
            a_i = alpha + failCount * alpha / K + (2 * alpha * X / N);
          } else {
            a_i = 2 * alpha + (2 * alpha * X / N);
          }
          a_i = Math.min(1.0, a_i);
        }

        let p_success = probFail * a_i;
        Y += i * p_success;
        probFail *= (1 - a_i);

        let b_i;
        if (failCount <= K) {
          b_i = alpha * eta + failCount * alpha * eta / K + (2 * alpha * eta * X / N);
        } else {
          b_i = 2 * alpha * eta + (2 * alpha * eta * X / N);
        }
        cumulative += b_i;

        if (probFail < 1e-8) break;
      }
      if (G === null) G = maxIter;
      return [Y, G];
    }

    const ctx = document.getElementById('chart').getContext('2d');
    const chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [
          { label: 'Y(X)', data: [], borderColor: '#6a0dad', fill: false },
          { label: 'G(X)', data: [], borderColor: '#ff4500', fill: false }
        ]
      },
      options: {
        responsive: true,
        scales: {
          x: { title: { display: true, text: 'X' } },
          y: { title: { display: true, text: '值' } }
        }
      }
    });

    function updateChart() {
      const alpha = parseFloat(document.getElementById('alpha').value);
      const N = parseInt(document.getElementById('N').value);
      const B = parseFloat(document.getElementById('B').value);
      const I = parseInt(document.getElementById('I').value);
      const Xinput = parseInt(document.getElementById('Xinput').value);

      const labels = [];
      const Ydata = [];
      const Gdata = [];
      for (let X = 0; X <= N; X++) {
        const [Y, G] = computeYandG(alpha, N, X, B, I);
        labels.push(X);
        Ydata.push(Y);
        Gdata.push(G);
      }

      chart.data.labels = labels;
      chart.data.datasets[0].data = Ydata;
      chart.data.datasets[1].data = Gdata;
      chart.update();

      const [Y_N, G_N] = computeYandG(alpha, N, N, B, I);
      const [Y_X, G_X] = computeYandG(alpha, N, Xinput, B, I);
      document.getElementById('results').innerHTML =
        `<strong>当前 X=N=${N}:</strong> Y=${Y_N.toFixed(2)}, G=${G_N}<br>` +
        `<strong>输入 X=${Xinput}:</strong> Y=${Y_X.toFixed(2)}, G=${G_X}`;
    }

    document.querySelectorAll('.controls input').forEach(input => {
      input.addEventListener('change', updateChart);
    });

    updateChart();
  </script>
</body>

</html>