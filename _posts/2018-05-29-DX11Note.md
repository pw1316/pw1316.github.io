---
layout: page
title: DirectX11 Tutorial
date: 2018-05-29 20:56:23 +0800
mdate: 2019-03-29 20:54:10 +0800
showbar: false
---

# Preface

# 1. Win32 框架

```mermaid
graph LR
A(WindowClass)-->B(Window)
B-->C(ShowWindow)
C-->D(MainLoop)
```

一般的主循环和消息机制挂钩，每次进入循环时先处理Windows系统消息，再做引擎相关的更新。而对Windows系统消息的利用要尽可能低，仅处理少量必要的窗口消息（菜单，新建/关闭窗口），其它需要处理的消息如用户键盘输入则交给上层引擎做。如非必要，尽量将Windows那一套东西仅用于提供引擎输出画面的窗口。

# 2. DirectX 11 绘制

## 上下文信息

- **IDXGISwapChain**：颜色缓存，和创建的**HWND**对象绑定来显示。
- **ID3D11Device**：提供显示设备相关的接口，用于创建各种资源。线程安全，可以多个线程同时访问。
- **ID3D11DeviceContext**：设备上下文，维护流水线状态。非线程安全，多线程访问需要进行线程同步。

## DirectX 11 流水线

```mermaid
graph TD
A[InputAssembler]-->B(VertexShader)
B-->C(HullShader)
C-->D[Tesselator]
C-->E(DomainShader)
D-->E
E-->F(GeometryShader)
F-->G[Rasterizer]
F-->H[StreamOutput]
G-->I(PixelShader)
I-->J[OutputMerger]
style A fill:#F596AA;
style B fill:#F596AA;
style C fill:#F596AA;
style E fill:#F596AA;
style F fill:#F596AA;
style H fill:#66BAB7;
style I fill:#58B2DC;
style J fill:#58B2DC;
```

<img style="width:12px;height:12px;background:#F596AA;">色表示可读取Memory

<img style="width:12px;height:12px;background:#66BAB7;">色表示可写入Memory

<img style="width:12px;height:12px;background:#58B2DC;">色表示可读写Memory

## InputAssembler Stage

- VertexBuffer(VB)：存储顶点数据，作为VertexShader(VS)的输入。
- IndexBuffer(IB)：存储顶点索引数据，描述顶点绘制顺序。
- PrimitiveTopology：描述如何从IB中的顶点索引组成图元，如**D3D11_PRIMITIVE_TOPOLOGY_TRIANGLELIST**表示每三个索引项对应的顶点组成一个三角形图元。
- InputLayout：存储顶点格式，VS根据该格式解析VB的数据。
> 由于InputLayout里定义的语义等信息直接对应VS的输入，因而创建时要提供VS的字节码。

## Rasterizer Stage

投影空间转到NDC，背面剔除，裁剪，光栅化，MSAA，视口绑定。

## OutputMerger Stage

- **ID3D11RenderTargetView**(RTV): 颜色缓存，最多8个，可以绑定任意**ID3D11Resource**对象，如果该对象是则同时用于显示。
- **ID3D11DepthStencilView**(DSV)：深度模板缓存，用于深度测试和模板测试。
- **ID3D11DepthStencilState**:深度模板测试参数，包括是否开启模板测试，是否开启深度测试，深度缓存写掩码，模板缓存读写掩码，正面背面相应的深度操作。
- **ID3D11BlendState**:每个RTV独立的混合参数，包括混合系数，混合操作。

## 初始化

初始化流程如下

```mermaid
graph LR
A(SwapChain)-->B(BackBuffer)
B-->C(RenderTargetView)
C-->D(RenderTarget)
E(DepthBuffer)-->F(DepthStencilView)
F-->D
D-->G(Context)
H(DepthStencilState)-->G
I(RasterizerState)-->G
J(Viewport)-->G
K(Device)-->B
K-->C
K-->E
K-->F
K-->H
K-->I
style A fill:#F596AA;
style D fill:#58B2DC;
style G fill:#F596AA;
style H fill:#58B2DC;
style I fill:#66BAB7;
style J fill:#66BAB7;
style K fill:#F596AA;
```

<img style="width:12px;height:12px;background:#F596AA;">色表示最先创建的内容，之后所有设备相关资源都需要通过Device来创建

<img style="width:12px;height:12px;background:#66BAB7;">色表示绘制管线上RasterizerStage所需内容

<img style="width:12px;height:12px;background:#58B2DC;">色表示绘制管线上OutputMergerStage所需内容

## DEMO中只运行一次的内容

* 初始化D3D，包括Rasterizer和OM
* 创建VB，IB，纹理
* 编译并创建Shader，创建InputLayout
* 创建Shader相关资源（ConstBuffer，SamplerState...）

## DEMO中每帧运行的内容

* 清理颜色缓存，深度缓存，模板缓存
* IA设置VB，IB，PrimitiveTopology，InputLayout
* VS设置相关资源
* PS设置相关资源
* DrawCall
